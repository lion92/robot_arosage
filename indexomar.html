<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StopClope Pro - Suivi Anti-Tabac Complet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-badges {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 20px;
        }

        .timeline {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            padding: 10px 0;
            margin-top: 15px;
        }

        .timeline-day {
            min-width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
        }

        .timeline-day.low {
            background: var(--success);
        }

        .timeline-day.medium {
            background: var(--warning);
        }

        .timeline-day.high {
            background: var(--danger);
        }

        .timeline-day.zero {
            background: var(--secondary);
        }

        /* Historique */
        .history-section {
            grid-column: 1 / -1;
        }

        .history-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .history-controls input,
        .history-controls select {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px;
            text-align: left;
        }

        .history-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.9em;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin: 0 2px;
        }

        .btn-edit {
            background: var(--warning);
            color: white;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.5s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .projection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .projection-controls label {
            font-weight: 500;
            color: #555;
        }

        .projection-controls input {
            width: 80px;
            padding: 5px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
        }

        .projection-controls button {
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="logo">üö≠ StopClope Pro</div>
        <div class="stats-badges">
            <div class="stat-badge">
                <span id="totalPoints">0</span> points
            </div>
            <div class="stat-badge" style="background: linear-gradient(135deg, var(--success), #059669);">
                <span id="currentStreak">0</span> jours de streak
            </div>
            <div class="stat-badge" style="background: linear-gradient(135deg, var(--warning), #d97706);">
                <span id="moneySaved">0</span>‚Ç¨ √©conomis√©s
            </div>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="quick-stats">
        <div class="stat-item">
            <div class="stat-value" id="todayCount">0</div>
            <div class="stat-label">Aujourd'hui</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="weekAvg">0</div>
            <div class="stat-label">Moyenne 7j</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="monthTotal">0</div>
            <div class="stat-label">Total mois</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="reduction">0%</div>
            <div class="stat-label">R√©duction</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="daysTracked">0</div>
            <div class="stat-label">Jours suivis</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="bestDay">-</div>
            <div class="stat-label">Record</div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Enregistrement -->
        <div class="card">
            <h2 class="card-title">üìù Enregistrement quotidien</h2>

            <div id="editMode" style="display: none; padding: 10px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                <strong>üîÑ Mode √©dition</strong> - Modification de l'entr√©e du <span id="editDate"></span>
                <button onclick="cancelEdit()" style="float: right; background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Annuler</button>
            </div>

            <div class="input-group">
                <label for="cigaretteCount">Nombre de cigarettes</label>
                <input type="number" id="cigaretteCount" min="0" max="100" placeholder="0">
            </div>

            <div class="input-group">
                <label for="date">Date</label>
                <input type="date" id="date">
            </div>

            <div class="input-group">
                <label for="mood">Humeur</label>
                <select id="mood">
                    <option value="üòä">üòä Excellent</option>
                    <option value="üôÇ">üôÇ Bien</option>
                    <option value="üòê">üòê Neutre</option>
                    <option value="üòî">üòî Difficile</option>
                    <option value="üò§">üò§ Tr√®s difficile</option>
                </select>
            </div>

            <button class="btn" id="saveBtn" onclick="addConsumption()">
                üíæ Enregistrer
            </button>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="exportData()">üì• Export</button>
                <button class="btn btn-secondary" onclick="generateDemoData()">üé≤ D√©mo</button>
                <button class="btn btn-danger" onclick="resetData()">üóëÔ∏è Reset</button>
            </div>
        </div>

        <!-- Graphique √©volution -->
        <div class="card">
            <h2 class="card-title">üìà √âvolution 30 jours</h2>
            <div class="chart-container">
                <canvas id="evolutionChart"></canvas>
            </div>
            <div class="timeline" id="timeline"></div>
        </div>

        <!-- Graphique projection th√©orique -->
        <div class="card">
            <h2 class="card-title">üìä Projection vs R√©alit√©</h2>
            <div class="projection-controls">
                <label>R√©duction/jour:</label>
                <input type="number" id="reductionRate" value="0.5" min="0.1" max="2" step="0.1">
                <label>Jours projection:</label>
                <input type="number" id="projectionDays" value="60" min="30" max="365" step="10">
                <button onclick="updateProjection()">Actualiser</button>
            </div>
            <div class="chart-container">
                <canvas id="projectionChart"></canvas>
            </div>
        </div>

        <!-- Objectifs -->
        <div class="card">
            <h2 class="card-title">‚öôÔ∏è Objectifs</h2>
            <div class="input-group">
                <label for="dailyGoal">Objectif quotidien (max)</label>
                <input type="number" id="dailyGoal" min="0" max="50" value="10" onchange="updateGoal()">
            </div>
            <div class="input-group">
                <label for="pricePerPack">Prix par paquet (‚Ç¨)</label>
                <input type="number" id="pricePerPack" min="0" step="0.5" value="10" onchange="updatePrice()">
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <div>Prix/cigarette : <strong id="pricePerCig">0.50‚Ç¨</strong></div>
                <div>Co√ªt/jour : <strong id="dailyCost">0‚Ç¨</strong></div>
                <div>√âconomie potentielle/an : <strong id="yearSaving">0‚Ç¨</strong></div>
            </div>
        </div>

        <!-- Historique -->
        <div class="card history-section">
            <h2 class="card-title">üìú Historique complet</h2>

            <div class="history-controls">
                <input type="text" id="searchHistory" placeholder="üîç Rechercher..." onkeyup="filterHistory()">
                <select id="filterMood" onchange="filterHistory()">
                    <option value="">Toutes les humeurs</option>
                    <option value="üòä">üòä Excellent</option>
                    <option value="üôÇ">üôÇ Bien</option>
                    <option value="üòê">üòê Neutre</option>
                    <option value="üòî">üòî Difficile</option>
                    <option value="üò§">üò§ Tr√®s difficile</option>
                </select>
                <select id="sortHistory" onchange="sortHistory()">
                    <option value="date-desc">Plus r√©cent</option>
                    <option value="date-asc">Plus ancien</option>
                    <option value="count-asc">Moins fum√©</option>
                    <option value="count-desc">Plus fum√©</option>
                </select>
            </div>

            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Cigarettes</th>
                        <th>Co√ªt</th>
                        <th>Humeur</th>
                        <th>Vs Objectif</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="historyTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #999;">
                            Aucune donn√©e. Cliquez sur "üé≤ D√©mo" pour voir un exemple.
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script>
    // Variables globales
    let userData = {
        points: 0,
        consumptions: [],
        streak: 0,
        dailyGoal: 10,
        pricePerPack: 10,
        totalCigarettesAvoided: 0,
        reductionRate: 0.5,
        projectionDays: 60
    };

    let charts = {};
    let currentSort = 'date-desc';
    let currentFilter = '';
    let isEditMode = false;
    let editingDate = null;

    // Initialisation
    function init() {
        loadData();
        setTodayDate();
        initCharts();
        updateDisplay();
    }

    // Charger les donn√©es
    function loadData() {
        const saved = localStorage.getItem('stopClopeData');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                userData = {
                    points: parsed.points || 0,
                    consumptions: Array.isArray(parsed.consumptions) ? parsed.consumptions : [],
                    streak: parsed.streak || 0,
                    dailyGoal: parsed.dailyGoal || 10,
                    pricePerPack: parsed.pricePerPack || 10,
                    totalCigarettesAvoided: parsed.totalCigarettesAvoided || 0,
                    reductionRate: parsed.reductionRate || 0.5,
                    projectionDays: parsed.projectionDays || 60
                };
            } catch (e) {
                console.error('Erreur de chargement', e);
                userData = {
                    points: 0,
                    consumptions: [],
                    streak: 0,
                    dailyGoal: 10,
                    pricePerPack: 10,
                    totalCigarettesAvoided: 0,
                    reductionRate: 0.5,
                    projectionDays: 60
                };
            }
        }

        document.getElementById('dailyGoal').value = userData.dailyGoal;
        document.getElementById('pricePerPack').value = userData.pricePerPack;
        document.getElementById('reductionRate').value = userData.reductionRate;
        document.getElementById('projectionDays').value = userData.projectionDays;
    }

    // Sauvegarder les donn√©es
    function saveData() {
        localStorage.setItem('stopClopeData', JSON.stringify(userData));
    }

    // D√©finir la date du jour
    function setTodayDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        document.getElementById('date').max = today;
    }

    // Notification
    function showNotification(message, type = 'success') {
        const notif = document.getElementById('notification');
        notif.textContent = message;
        notif.className = `notification ${type}`;
        notif.style.display = 'block';

        setTimeout(() => {
            notif.style.display = 'none';
        }, 3000);
    }

    // Ajouter ou modifier une consommation
    function addConsumption() {
        const count = parseInt(document.getElementById('cigaretteCount').value) || 0;
        const date = document.getElementById('date').value;
        const mood = document.getElementById('mood').value;

        if (!date) {
            showNotification('Veuillez s√©lectionner une date', 'warning');
            return;
        }

        if (count < 0 || count > 100) {
            showNotification('Nombre invalide (0-100)', 'warning');
            return;
        }

        if (isEditMode && editingDate && editingDate !== date) {
            userData.consumptions = userData.consumptions.filter(c => c.date !== editingDate);
        }

        const existingIndex = userData.consumptions.findIndex(c => c.date === date);

        if (existingIndex !== -1) {
            userData.consumptions[existingIndex] = { date, count, mood };
            showNotification('Journ√©e mise √† jour avec succ√®s !', 'success');
        } else {
            userData.consumptions.push({ date, count, mood });
            userData.consumptions.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (!isEditMode) {
                userData.points += 5;
                const newIndex = userData.consumptions.findIndex(c => c.date === date);

                if (newIndex > 0) {
                    const prev = userData.consumptions[newIndex - 1];
                    if (count < prev.count) {
                        const reduction = prev.count - count;
                        userData.points += reduction * 10;
                        userData.totalCigarettesAvoided += reduction;
                        showNotification(`R√©duction d√©tect√©e ! -${reduction} cigarettes = +${reduction * 10} points üéâ`, 'success');
                    }
                }
            }

            if (!isEditMode) {
                showNotification('Journ√©e enregistr√©e avec succ√®s !', 'success');
            } else {
                showNotification('Journ√©e modifi√©e avec succ√®s !', 'success');
            }
        }

        cancelEdit();
        saveData();
        updateDisplay();

        document.getElementById('cigaretteCount').value = '';
        setTodayDate();
    }

    // √âditer une entr√©e
    function editEntry(date) {
        const entry = userData.consumptions.find(c => c.date === date);
        if (!entry) {
            showNotification('Entr√©e non trouv√©e', 'warning');
            return;
        }

        isEditMode = true;
        editingDate = date;

        document.getElementById('date').value = date;
        document.getElementById('cigaretteCount').value = entry.count;
        document.getElementById('mood').value = entry.mood || 'üòê';

        document.getElementById('editMode').style.display = 'block';
        document.getElementById('editDate').textContent = new Date(date).toLocaleDateString('fr-FR');

        const saveBtn = document.getElementById('saveBtn');
        saveBtn.innerHTML = '‚úèÔ∏è Modifier';
        saveBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';

        document.querySelector('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
        showNotification('Modifiez les valeurs et cliquez sur Modifier', 'info');
    }

    // Annuler l'√©dition
    function cancelEdit() {
        isEditMode = false;
        editingDate = null;

        document.getElementById('editMode').style.display = 'none';

        const saveBtn = document.getElementById('saveBtn');
        saveBtn.innerHTML = 'üíæ Enregistrer';
        saveBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';

        document.getElementById('cigaretteCount').value = '';
        setTodayDate();
        document.getElementById('mood').value = 'üòä';
    }

    // Supprimer une entr√©e
    function deleteEntry(date) {
        const entry = userData.consumptions.find(c => c.date === date);
        if (!entry) {
            showNotification('Entr√©e non trouv√©e', 'warning');
            return;
        }

        const dateStr = new Date(date).toLocaleDateString('fr-FR');
        const confirmMsg = `Voulez-vous vraiment supprimer l'entr√©e du ${dateStr} ?\n\nCigarettes: ${entry.count}\nHumeur: ${entry.mood || 'Non d√©finie'}`;

        if (confirm(confirmMsg)) {
            userData.consumptions = userData.consumptions.filter(c => c.date !== date);
            saveData();
            updateDisplay();
            showNotification(`Entr√©e du ${dateStr} supprim√©e avec succ√®s !`, 'success');
        }
    }

    // Mettre √† jour l'affichage
    function updateDisplay() {
        if (!userData) {
            userData = {
                points: 0,
                consumptions: [],
                streak: 0,
                dailyGoal: 10,
                pricePerPack: 10,
                totalCigarettesAvoided: 0,
                reductionRate: 0.5,
                projectionDays: 60
            };
        }

        // Stats principales
        document.getElementById('totalPoints').textContent = userData.points || 0;
        document.getElementById('currentStreak').textContent = calculateStreak();
        document.getElementById('moneySaved').textContent = getMoneySaved();

        // Stats rapides
        const today = new Date().toISOString().split('T')[0];
        const todayData = userData.consumptions.find(c => c.date === today);
        document.getElementById('todayCount').textContent = todayData ? todayData.count : 0;
        document.getElementById('weekAvg').textContent = getWeekAverage().toFixed(1);
        document.getElementById('monthTotal').textContent = getMonthTotal();
        document.getElementById('reduction').textContent = getReductionPercentage() + '%';
        document.getElementById('daysTracked').textContent = userData.consumptions.length;
        document.getElementById('bestDay').textContent = getBestDay();

        // Prix
        const pricePerCig = userData.pricePerPack / 20;
        document.getElementById('pricePerCig').textContent = pricePerCig.toFixed(2) + '‚Ç¨';

        const avgDaily = getWeekAverage();
        const dailyCost = avgDaily * pricePerCig;
        const yearSaving = avgDaily * pricePerCig * 365;

        document.getElementById('dailyCost').textContent = dailyCost.toFixed(2) + '‚Ç¨';
        document.getElementById('yearSaving').textContent = yearSaving.toFixed(0) + '‚Ç¨';

        updateCharts();
        updateTimeline();
        updateHistory();
        updateProjection();
    }

    // Calculs
    function calculateStreak() {
        if (!userData.consumptions || userData.consumptions.length < 2) return 0;
        let streak = 0;
        for (let i = userData.consumptions.length - 1; i > 0; i--) {
            const current = userData.consumptions[i].count || 0;
            const previous = userData.consumptions[i-1].count || 0;
            if (current < previous) {
                streak++;
            } else {
                break;
            }
        }
        return streak;
    }

    function getMoneySaved() {
        const pricePerCig = userData.pricePerPack / 20;
        const avoided = userData.totalCigarettesAvoided || 0;
        return Math.round(avoided * pricePerCig);
    }

    function getWeekAverage() {
        if (!userData.consumptions || userData.consumptions.length === 0) return 0;
        const last7 = userData.consumptions.slice(-7);
        if (last7.length === 0) return 0;
        const sum = last7.reduce((total, c) => total + (c.count || 0), 0);
        return sum / last7.length;
    }

    function getMonthTotal() {
        if (!userData.consumptions || userData.consumptions.length === 0) return 0;
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        return userData.consumptions
            .filter(c => c.date >= monthStart)
            .reduce((sum, c) => sum + (c.count || 0), 0);
    }

    function getReductionPercentage() {
        if (!userData.consumptions || userData.consumptions.length < 2) return 0;
        const first = userData.consumptions[0].count || 0;
        const last = userData.consumptions[userData.consumptions.length - 1].count || 0;
        if (first === 0) return 0;
        const reduction = ((first - last) / first) * 100;
        return Math.max(0, Math.round(reduction));
    }

    function getBestDay() {
        if (!userData.consumptions || userData.consumptions.length === 0) return '-';
        const counts = userData.consumptions.map(c => c.count || 0);
        return Math.min(...counts);
    }

    // Graphiques
    function initCharts() {
        // Graphique √©volution
        const ctx1 = document.getElementById('evolutionChart');
        if (ctx1) {
            charts.evolution = new Chart(ctx1.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cigarettes',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Graphique projection
        const ctx2 = document.getElementById('projectionChart');
        if (ctx2) {
            charts.projection = new Chart(ctx2.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Consommation r√©elle',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Projection th√©orique',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Objectif',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 1,
                            borderDash: [10, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cigarettes/jour'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Jours'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(1) + ' cig.';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    function updateCharts() {
        if (charts.evolution && userData.consumptions && userData.consumptions.length > 0) {
            const last30 = userData.consumptions.slice(-30);
            charts.evolution.data.labels = last30.map(c => {
                const date = new Date(c.date);
                return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
            });
            charts.evolution.data.datasets[0].data = last30.map(c => c.count || 0);
            charts.evolution.update();
        }
    }

    function updateProjection() {
        if (!charts.projection || !userData.consumptions || userData.consumptions.length === 0) return;

        const reductionRate = parseFloat(document.getElementById('reductionRate').value) || 0.5;
        const projectionDays = parseInt(document.getElementById('projectionDays').value) || 60;

        userData.reductionRate = reductionRate;
        userData.projectionDays = projectionDays;
        saveData();

        // Pr√©parer les donn√©es
        const labels = [];
        const realData = [];
        const projectionData = [];
        const goalData = [];

        // Donn√©es r√©elles existantes
        userData.consumptions.forEach((c, index) => {
            labels.push(`Jour ${index + 1}`);
            realData.push(c.count);
            projectionData.push(null); // Pas de projection pour les jours pass√©s
            goalData.push(userData.dailyGoal);
        });

        // Calculer la projection
        let startValue = userData.consumptions.length > 0
            ? userData.consumptions[userData.consumptions.length - 1].count
            : userData.dailyGoal;

        const startDay = userData.consumptions.length;

        // Ajouter la projection future
        for (let i = 0; i < projectionDays; i++) {
            const dayNum = startDay + i + 1;
            labels.push(`Jour ${dayNum}`);

            // Projection th√©orique avec r√©duction progressive
            let projectedValue = startValue * Math.pow(1 - (reductionRate / 100), i + 1);
            projectedValue = Math.max(0, projectedValue); // Ne pas descendre en dessous de 0

            realData.push(null); // Pas de donn√©es r√©elles pour le futur
            projectionData.push(projectedValue);
            goalData.push(userData.dailyGoal);
        }

        // Connecter la projection aux donn√©es r√©elles
        if (userData.consumptions.length > 0) {
            projectionData[userData.consumptions.length - 1] = startValue;
        }

        // Mettre √† jour le graphique
        charts.projection.data.labels = labels;
        charts.projection.data.datasets[0].data = realData;
        charts.projection.data.datasets[1].data = projectionData;
        charts.projection.data.datasets[2].data = goalData;
        charts.projection.update();
    }

    // Timeline
    function updateTimeline() {
        const timeline = document.getElementById('timeline');
        if (!timeline) return;

        timeline.innerHTML = '';

        if (!userData.consumptions || userData.consumptions.length === 0) {
            timeline.innerHTML = '<div style="color: #999; padding: 10px;">Aucune donn√©e</div>';
            return;
        }

        const last30 = userData.consumptions.slice(-30);

        last30.forEach(c => {
            const div = document.createElement('div');
            div.className = 'timeline-day';
            const count = c.count || 0;

            if (count === 0) {
                div.classList.add('zero');
            } else if (count <= userData.dailyGoal * 0.5) {
                div.classList.add('low');
            } else if (count <= userData.dailyGoal) {
                div.classList.add('medium');
            } else {
                div.classList.add('high');
            }

            div.textContent = count;
            const dateObj = new Date(c.date);
            div.title = dateObj.toLocaleDateString('fr-FR') + ' : ' + count + ' cigarettes';
            timeline.appendChild(div);
        });
    }

    // Historique
    function updateHistory() {
        const tbody = document.getElementById('historyTableBody');
        if (!tbody) return;

        if (!userData.consumptions || userData.consumptions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: #999; padding: 20px;">
                        Aucune donn√©e. Cliquez sur "üé≤ D√©mo" pour voir un exemple.
                    </td>
                </tr>
            `;
            return;
        }

        let data = [...userData.consumptions];

        // Filtres
        const searchTerm = (document.getElementById('searchHistory').value || '').toLowerCase();
        const moodFilter = document.getElementById('filterMood').value;

        if (searchTerm) {
            data = data.filter(c => {
                const date = new Date(c.date).toLocaleDateString('fr-FR').toLowerCase();
                return date.includes(searchTerm);
            });
        }

        if (moodFilter) {
            data = data.filter(c => c.mood === moodFilter);
        }

        // Tri
        const sortValue = document.getElementById('sortHistory').value || 'date-desc';

        switch(sortValue) {
            case 'date-asc':
                data.sort((a, b) => new Date(a.date) - new Date(b.date));
                break;
            case 'date-desc':
                data.sort((a, b) => new Date(b.date) - new Date(a.date));
                break;
            case 'count-asc':
                data.sort((a, b) => (a.count || 0) - (b.count || 0));
                break;
            case 'count-desc':
                data.sort((a, b) => (b.count || 0) - (a.count || 0));
                break;
        }

        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: #999;">
                        Aucune donn√©e trouv√©e avec ces filtres
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = '';
        const pricePerCig = userData.pricePerPack / 20;

        const displayData = data.slice(0, 50);

        displayData.forEach(c => {
            const row = document.createElement('tr');
            const count = c.count || 0;
            const diff = userData.dailyGoal - count;
            const diffStr = diff >= 0 ?
                `<span style="color: var(--success);">-${diff} ‚úì</span>` :
                `<span style="color: var(--danger);">+${Math.abs(diff)} ‚úó</span>`;

            const dateStr = new Date(c.date).toLocaleDateString('fr-FR');
            const cost = (count * pricePerCig).toFixed(2);

            row.innerHTML = `
                <td>${dateStr}</td>
                <td><strong>${count}</strong></td>
                <td>${cost}‚Ç¨</td>
                <td>${c.mood || '-'}</td>
                <td>${diffStr}</td>
                <td>
                    <button class="btn-small btn-edit" onclick="editEntry('${c.date}')">‚úèÔ∏è</button>
                    <button class="btn-small btn-delete" onclick="deleteEntry('${c.date}')">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        if (data.length > 50) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td colspan="6" style="text-align: center; color: #999; padding: 10px;">
                    ... et ${data.length - 50} autres entr√©es
                </td>
            `;
            tbody.appendChild(row);
        }
    }

    function filterHistory() {
        updateHistory();
    }

    function sortHistory() {
        updateHistory();
    }

    // Objectifs
    function updateGoal() {
        const value = parseInt(document.getElementById('dailyGoal').value);
        if (!isNaN(value) && value >= 0 && value <= 100) {
            userData.dailyGoal = value;
            saveData();
            updateDisplay();
            showNotification('Objectif mis √† jour', 'success');
        }
    }

    function updatePrice() {
        const value = parseFloat(document.getElementById('pricePerPack').value);
        if (!isNaN(value) && value >= 0 && value <= 100) {
            userData.pricePerPack = value;
            saveData();
            updateDisplay();
            showNotification('Prix mis √† jour', 'success');
        }
    }

    // Export/Import
    function exportData() {
        const dataStr = JSON.stringify(userData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `stopclope-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        showNotification('Donn√©es export√©es', 'success');
    }

    function resetData() {
        if (confirm('Effacer toutes les donn√©es ?')) {
            localStorage.removeItem('stopClopeData');
            location.reload();
        }
    }

    // G√©n√©rer donn√©es de d√©mo
    function generateDemoData() {
        const today = new Date();
        const demoData = [];

        for (let i = 29; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];

            // Simulation d'une r√©duction progressive avec quelques variations
            const baseReduction = Math.floor(i / 3);
            const randomVariation = Math.floor(Math.random() * 3) - 1;
            const count = Math.max(3, 15 - baseReduction + randomVariation);

            const moods = ['üòä', 'üôÇ', 'üòê', 'üòî', 'üò§'];
            const moodIndex = count <= 10 ? Math.floor(Math.random() * 2) : Math.floor(Math.random() * 3) + 2;
            const mood = moods[moodIndex];

            demoData.push({ date: dateStr, count, mood });
        }

        userData.consumptions = demoData;
        userData.points = 250;
        userData.totalCigarettesAvoided = 50;

        saveData();
        updateDisplay();
        showNotification('30 jours de donn√©es de d√©monstration ajout√©es !', 'success');
    }

    // Rendre les fonctions globales
    window.addConsumption = addConsumption;
    window.updateGoal = updateGoal;
    window.updatePrice = updatePrice;
    window.updateProjection = updateProjection;
    window.exportData = exportData;
    window.resetData = resetData;
    window.generateDemoData = generateDemoData;
    window.filterHistory = filterHistory;
    window.sortHistory = sortHistory;
    window.editEntry = editEntry;
    window.deleteEntry = deleteEntry;
    window.cancelEdit = cancelEdit;

    // D√©marrage
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>