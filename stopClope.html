<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StopClope - Tracker & D√©fis</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      animation: slideDown 0.5s ease;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.95;
    }

    .stats-bar {
      background: white;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
      animation: fadeIn 0.6s ease;
    }

    .stat-item {
      text-align: center;
      flex: 1;
      min-width: 120px;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      animation: slideUp 0.7s ease;
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .icon {
      font-size: 1.2em;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }

    .input-group input, .input-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }

    .btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .challenges-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .challenge-item {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .challenge-item:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }

    .challenge-item.active {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border: 2px solid #667eea;
    }

    .challenge-item.completed {
      background: #d4edda;
      border: 2px solid #28a745;
    }

    .challenge-info {
      flex: 1;
    }

    .challenge-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .challenge-desc {
      font-size: 0.9em;
      color: #666;
    }

    .challenge-points {
      background: #ffd700;
      color: #333;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9em;
    }

    .history-list {
      max-height: 250px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.3s ease;
    }

    .history-item:hover {
      background: #f8f9fa;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #20c997);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8em;
      font-weight: bold;
    }

    .trophy {
      font-size: 2em;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: none;
      animation: slideInRight 0.5s ease;
      z-index: 1000;
    }

    .notification.success {
      border-left: 4px solid #28a745;
    }

    .notification.info {
      border-left: 4px solid #667eea;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üö≠ StopClope</h1>
    <p>Suivez votre consommation, relevez des d√©fis, gagnez des points !</p>
  </div>

  <div class="stats-bar">
    <div class="stat-item">
      <div class="stat-value" id="totalPoints">0</div>
      <div class="stat-label">Points totaux</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="todayCount">0</div>
      <div class="stat-label">Cigarettes aujourd'hui</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="avgDaily">0</div>
      <div class="stat-label">Moyenne / jour</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="streak">0</div>
      <div class="stat-label">Jours de r√©duction</div>
    </div>
  </div>

  <div class="main-grid">
    <div class="card">
      <h2><span class="icon">üìä</span> Enregistrer ma consommation</h2>
      <div class="input-group">
        <label for="cigaretteCount">Nombre de cigarettes aujourd'hui</label>
        <input type="number" id="cigaretteCount" min="0" max="100" placeholder="Ex: 5">
      </div>
      <div class="input-group">
        <label for="date">Date</label>
        <input type="date" id="date" value="">
      </div>
      <button class="btn" onclick="addConsumption()">Enregistrer</button>

      <div class="progress-bar" style="margin-top: 20px;">
        <div class="progress-fill" id="dailyProgress" style="width: 0%">
          <span id="progressText">0%</span>
        </div>
      </div>
      <p style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em;">
        Objectif quotidien : <span id="dailyGoal">10</span> cigarettes max
      </p>
    </div>

    <div class="card">
      <h2><span class="icon">üèÜ</span> D√©fis disponibles</h2>
      <div class="challenges-list" id="challengesList">
        <!-- Les d√©fis seront ajout√©s ici dynamiquement -->
      </div>
    </div>
  </div>

  <div class="card">
    <h2><span class="icon">üìà</span> Historique r√©cent</h2>
    <div class="history-list" id="historyList">
      <p style="text-align: center; color: #999;">Aucune donn√©e pour le moment</p>
    </div>
    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
      <button class="btn" style="flex: 1; background: #6c757d;" onclick="exportData()">
        üíæ Exporter les donn√©es
      </button>
      <label class="btn" style="flex: 1; background: #28a745; text-align: center;">
        üì• Importer
        <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
      </label>
      <button class="btn" style="flex: 1; background: #dc3545;" onclick="resetData()">
        üóëÔ∏è R√©initialiser
      </button>
    </div>
  </div>
</div>

<div class="notification" id="notification"></div>

<script>
  // Initialisation des donn√©es
  let userData = {
    points: 0,
    consumptions: [],
    challenges: [],
    streak: 0,
    dailyGoal: 10,
    lastLogin: new Date().toISOString(),
    totalCigarettesAvoided: 0,
    bestStreak: 0,
    userProfile: {
      name: '',
      startDate: new Date().toISOString(),
      initialDaily: 20
    }
  };

  // Charger les donn√©es depuis localStorage
  function loadData() {
    try {
      const saved = localStorage.getItem('stopClopeData');
      if (saved) {
        const parsedData = JSON.parse(saved);
        // Fusionner avec les valeurs par d√©faut pour les nouvelles propri√©t√©s
        userData = { ...userData, ...parsedData };
        console.log('Donn√©es charg√©es depuis localStorage:', userData);
      } else {
        console.log('Premi√®re utilisation - initialisation des donn√©es');
        // Premi√®re utilisation, initialiser et sauvegarder
        saveData();
      }
    } catch (error) {
      console.error('Erreur lors du chargement des donn√©es:', error);
      showNotification('Erreur lors du chargement des donn√©es', 'error');
    }
    updateDisplay();
  }

  // Sauvegarder les donn√©es avec gestion d'erreur
  function saveData() {
    try {
      userData.lastLogin = new Date().toISOString();
      localStorage.setItem('stopClopeData', JSON.stringify(userData));
      console.log('Donn√©es sauvegard√©es dans localStorage');
    } catch (error) {
      console.error('Erreur lors de la sauvegarde:', error);
      if (error.name === 'QuotaExceededError') {
        showNotification('Espace de stockage plein. Veuillez lib√©rer de l\'espace.', 'error');
      }
    }
  }

  // Fonction pour exporter les donn√©es (backup)
  function exportData() {
    const dataStr = JSON.stringify(userData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `stopclope-backup-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    showNotification('Donn√©es export√©es avec succ√®s !', 'success');
  }

  // Fonction pour importer les donn√©es
  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedData = JSON.parse(e.target.result);
        userData = { ...userData, ...importedData };
        saveData();
        updateDisplay();
        showNotification('Donn√©es import√©es avec succ√®s !', 'success');
      } catch (error) {
        showNotification('Erreur lors de l\'import des donn√©es', 'error');
      }
    };
    reader.readAsText(file);
  }

  // Fonction pour r√©initialiser les donn√©es
  function resetData() {
    if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser toutes vos donn√©es ? Cette action est irr√©versible.')) {
      localStorage.removeItem('stopClopeData');
      location.reload();
    }
  }

  // D√©finition des d√©fis
  const challenges = [
    { id: 1, name: "Premier pas", desc: "Enregistrer votre premi√®re journ√©e", points: 10, type: "single" },
    { id: 2, name: "R√©duction l√©g√®re", desc: "Fumer 2 cigarettes de moins qu'hier", points: 20, type: "reduction" },
    { id: 3, name: "Mi-journ√©e sans tabac", desc: "Ne pas fumer avant midi", points: 30, type: "timing" },
    { id: 4, name: "Semaine de progr√®s", desc: "R√©duire chaque jour pendant 7 jours", points: 100, type: "streak" },
    { id: 5, name: "Champion du jour", desc: "Fumer moins de 5 cigarettes aujourd'hui", points: 50, type: "limit" },
    { id: 6, name: "Weekend light", desc: "R√©duire de 50% le weekend", points: 60, type: "weekend" },
    { id: 7, name: "Mois en baisse", desc: "Moyenne mensuelle < mois pr√©c√©dent", points: 200, type: "monthly" },
    { id: 8, name: "Z√©ro h√©ros", desc: "Une journ√©e compl√®te sans cigarette", points: 150, type: "zero" }
  ];

  // Afficher les d√©fis
  function displayChallenges() {
    const list = document.getElementById('challengesList');
    list.innerHTML = '';

    challenges.forEach(challenge => {
      const isCompleted = userData.challenges.includes(challenge.id);
      const div = document.createElement('div');
      div.className = `challenge-item ${isCompleted ? 'completed' : ''}`;
      div.innerHTML = `
                    <div class="challenge-info">
                        <div class="challenge-name">${isCompleted ? '‚úÖ ' : ''}${challenge.name}</div>
                        <div class="challenge-desc">${challenge.desc}</div>
                    </div>
                    <div class="challenge-points">+${challenge.points} pts</div>
                `;

      if (!isCompleted) {
        div.onclick = () => attemptChallenge(challenge);
      }

      list.appendChild(div);
    });
  }

  // Tenter un d√©fi
  function attemptChallenge(challenge) {
    let completed = false;
    const today = new Date().toISOString().split('T')[0];
    const todayData = userData.consumptions.find(c => c.date === today);

    switch(challenge.type) {
      case 'single':
        if (userData.consumptions.length > 0) completed = true;
        break;
      case 'limit':
        if (todayData && todayData.count <= 5) completed = true;
        break;
      case 'zero':
        if (todayData && todayData.count === 0) completed = true;
        break;
      case 'reduction':
        if (userData.consumptions.length >= 2) {
          const yesterday = userData.consumptions[userData.consumptions.length - 2];
          if (todayData && todayData.count < yesterday.count - 1) completed = true;
        }
        break;
    }

    if (completed && !userData.challenges.includes(challenge.id)) {
      userData.challenges.push(challenge.id);
      userData.points += challenge.points;
      saveData();
      showNotification(`D√©fi "${challenge.name}" compl√©t√© ! +${challenge.points} points`, 'success');
      updateDisplay();
    } else if (!completed) {
      showNotification(`Conditions non remplies pour ce d√©fi`, 'info');
    }
  }

  // Ajouter une consommation
  function addConsumption() {
    const count = parseInt(document.getElementById('cigaretteCount').value);
    const date = document.getElementById('date').value;

    if (isNaN(count) || count < 0) {
      showNotification('Veuillez entrer un nombre valide', 'info');
      return;
    }

    if (!date) {
      showNotification('Veuillez s√©lectionner une date', 'info');
      return;
    }

    // V√©rifier si une entr√©e existe d√©j√† pour cette date
    const existingIndex = userData.consumptions.findIndex(c => c.date === date);
    if (existingIndex !== -1) {
      userData.consumptions[existingIndex].count = count;
      showNotification('Consommation mise √† jour !', 'info');
    } else {
      userData.consumptions.push({ date, count });
      userData.consumptions.sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    // Bonus de points pour la r√©duction
    if (userData.consumptions.length > 1) {
      const previous = userData.consumptions[userData.consumptions.length - 2];
      if (count < previous.count) {
        const bonus = (previous.count - count) * 5;
        userData.points += bonus;
        userData.totalCigarettesAvoided += (previous.count - count);
        showNotification(`R√©duction d√©tect√©e ! +${bonus} points`, 'success');
      }
    }

    // Points de base pour l'enregistrement
    userData.points += 2;

    // Mettre √† jour le meilleur streak
    const currentStreak = calculateStreak();
    if (currentStreak > userData.bestStreak) {
      userData.bestStreak = currentStreak;
    }

    saveData();
    updateDisplay();
    checkAutoChallenges();

    document.getElementById('cigaretteCount').value = '';
    showNotification('Consommation enregistr√©e et sauvegard√©e !', 'success');
  }

  // V√©rifier automatiquement certains d√©fis
  function checkAutoChallenges() {
    challenges.forEach(challenge => {
      if (!userData.challenges.includes(challenge.id)) {
        attemptChallenge(challenge);
      }
    });
  }

  // Mettre √† jour l'affichage
  function updateDisplay() {
    document.getElementById('totalPoints').textContent = userData.points;

    // Cigarettes aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    const todayData = userData.consumptions.find(c => c.date === today);
    const todayCount = todayData ? todayData.count : 0;
    document.getElementById('todayCount').textContent = todayCount;

    // Moyenne quotidienne
    if (userData.consumptions.length > 0) {
      const total = userData.consumptions.reduce((sum, c) => sum + c.count, 0);
      const avg = (total / userData.consumptions.length).toFixed(1);
      document.getElementById('avgDaily').textContent = avg;
    }

    // Calcul du streak
    const streak = calculateStreak();
    document.getElementById('streak').textContent = streak;

    // Barre de progression quotidienne
    const progress = Math.min(100, (todayCount / userData.dailyGoal) * 100);
    const progressBar = document.getElementById('dailyProgress');
    const progressText = document.getElementById('progressText');
    progressBar.style.width = progress + '%';

    if (progress <= 50) {
      progressBar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
      progressText.textContent = `${Math.round(progress)}% - Excellent !`;
    } else if (progress <= 80) {
      progressBar.style.background = 'linear-gradient(90deg, #ffc107, #ff9800)';
      progressText.textContent = `${Math.round(progress)}% - Bien`;
    } else {
      progressBar.style.background = 'linear-gradient(90deg, #dc3545, #c82333)';
      progressText.textContent = `${Math.round(progress)}% - Attention`;
    }

    // Afficher l'historique
    displayHistory();
    displayChallenges();
  }

  // Fonction pour calculer le streak
  function calculateStreak() {
    let streak = 0;
    for (let i = userData.consumptions.length - 1; i > 0; i--) {
      if (userData.consumptions[i].count < userData.consumptions[i-1].count) {
        streak++;
      } else {
        break;
      }
    }
    return streak;
  }

  // Afficher l'historique
  function displayHistory() {
    const list = document.getElementById('historyList');
    if (userData.consumptions.length === 0) {
      list.innerHTML = '<p style="text-align: center; color: #999;">Aucune donn√©e pour le moment</p>';
      return;
    }

    list.innerHTML = '';
    const recent = userData.consumptions.slice(-7).reverse();
    recent.forEach((entry, index) => {
      const date = new Date(entry.date);
      const dateStr = date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });

      const div = document.createElement('div');
      div.className = 'history-item';

      let trend = '';
      if (index < recent.length - 1) {
        const previous = recent[index + 1];
        if (entry.count < previous.count) trend = 'üìâ';
        else if (entry.count > previous.count) trend = 'üìà';
        else trend = '‚û°Ô∏è';
      }

      div.innerHTML = `
                    <span>${dateStr}</span>
                    <span><strong>${entry.count}</strong> cigarettes ${trend}</span>
                `;
      list.appendChild(div);
    });
  }

  // Notification
  function showNotification(message, type = 'info') {
    const notif = document.getElementById('notification');
    notif.textContent = message;
    notif.className = `notification ${type}`;
    notif.style.display = 'block';

    setTimeout(() => {
      notif.style.display = 'none';
    }, 3000);
  }

  // Initialisation
  document.addEventListener('DOMContentLoaded', function() {
    // D√©finir la date du jour par d√©faut
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;

    loadData();
  });
</script>
</body>
</html>